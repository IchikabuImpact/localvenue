<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>enchanbaken  — レース詳細（モック）</title>
  <link rel="stylesheet" href="./localvenue-mockup.css" />
</head>
<body>
  <header class="header">
    <div class="header__inner container">
      <div class="brand">Localvenue <span class="sub">horse racing analytics</span></div>
      <nav class="nav" aria-label="Primary">
        <a href="./index.html">開催一覧</a>
        <a href="#" aria-current="page">レース詳細</a>
        <a href="#">回収率</a>
      </nav>
    </div>
  </header>

  <main class="main container">
    <div class="race-header card mb-8">
      <div class="card__body">
        <div class="race-title" id="race-title">レース詳細</div>
        <div class="race-meta" id="race-meta">
          <span class="pill">race_id=<code class="inline" id="race-id">—</code></span>
          <span class="pill" id="race-date">—</span>
          <span class="pill" id="race-course">—</span>
          <span class="pill" id="race-no">—</span>
        </div>
        <div class="mt-12 pills">
          <span class="tag tag--win">単勝</span>
          <span class="tag tag--place">複勝</span>
          <span class="tag tag--quinella">BOX</span>
        </div>
      </div>
    </div>

    <section class="card mb-12">
      <div class="card__header">
        <div class="card__title">推奨（public/yosou/{race_id}.php をそのまま描画）</div>
        <div class="card__actions"><button class="btn" id="btn-open-yosou">元ファイル</button></div>
      </div>
      <div class="card__body">
        <div id="yosou-html" class="content"></div>
        <div class="notice notice--warn mt-12" id="yosou-fallback" style="display:none">
          <div>⚠️</div>
          <div>予想HTMLが取得できませんでした。race_id とファイル存在を確認してください。</div>
          <div><button class="btn btn--ghost" id="btn-retry">再試行</button></div>
        </div>
      </div>
    </section>

    <section class="card mb-12">
      <div class="card__header"><div class="card__title">BOX（上位4頭）</div></div>
      <div class="card__body">
        <div class="row row--wrap gap-8" id="box-chips"><span class="badge">読み込み中…</span></div>
      </div>
    </section>

    <section class="card">
      <div class="card__header">
        <div class="card__title">メモ</div>
      </div>
      <div class="card__body">
        <ul class="list">
          <li><span>ZF1 旧URL</span> <span class="badge">/index/detail/race_id/:race_id</span></li>
          <li><span>現モックURL</span> <span class="badge">/detail.html?race_id=YYYYMMDD_{場コード}_{R}</span></li>
          <li><span>Rはゼロ埋め</span> <span class="badge">なし（現物準拠）</span></li>
        </ul>
      </div>
    </section>

    <p class="kb-help mt-16">ヒント: クエリに <span class="kbd">?race_id=20241124_11_1</span> などを付けてアクセスします。</p>
  </main>

  <footer class="footer container">
    <div class="footer-links">
      <a href="./index.html">開催一覧</a>
      <a href="#">利用規約</a>
    </div>
  </footer>

  <script>
    // race_id 解析: YYYYMMDD_{baba}_{R}（Rは1-2桁、ゼロ埋めなし）
    function parseRaceId(rid) {
      const m = String(rid||"").match(/^(\d{8})_(\d{1,2})_(\d{1,2})$/);
      if (!m) return null;
      const [_, ymd, baba, rno] = m;
      return { ymd, baba, rno };
    }

    const $ = (sel) => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const raceId = params.get('race_id') || '';
    $('#race-id').textContent = raceId || '—';

    const parsed = parseRaceId(raceId);
    if (parsed) {
      const y = parsed.ymd.slice(0,4), m = parsed.ymd.slice(4,6), d = parsed.ymd.slice(6,8);
      $('#race-date').textContent = `${y}-${m}-${d}`;
      $('#race-course').textContent = `場コード: ${parsed.baba}`;
      $('#race-no').textContent = `R: ${parsed.rno}`;
      $('#race-title').textContent = `レース詳細 ${y}-${m}-${d} 場${parsed.baba} ${parsed.rno}R`;
    }

    const yosouUrl = raceId ? `/yosou/${raceId}.php` : '';
    const boxUrl   = raceId ? `/yosou/${raceId}_box.txt` : '';

    const btnOpen = $('#btn-open-yosou');
    btnOpen.addEventListener('click', () => { if (yosouUrl) window.open(yosouUrl, '_blank'); });

    function loadYosou() {
      if (!yosouUrl) return;
      fetch(yosouUrl, { credentials: 'same-origin' })
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(html => { $('#yosou-html').innerHTML = html; $('#yosou-fallback').style.display = 'none'; })
        .catch(() => { $('#yosou-fallback').style.display = 'grid'; });
    }

    function loadBox() {
      if (!boxUrl) { $('#box-chips').textContent = 'race_id が未指定です'; return; }
      fetch(boxUrl, { credentials: 'same-origin' })
        .then(r => r.ok ? r.text() : '')
        .then(txt => {
          const wrap = $('#box-chips');
          wrap.innerHTML = '';
          const nums = (txt||'').trim().split(/\s*,\s*/).filter(Boolean);
          if (!nums.length) { wrap.textContent = 'BOX情報なし'; return; }
          nums.forEach(n => {
            const s = document.createElement('span');
            s.className = 'chip';
            s.textContent = `${n}番`;
            wrap.appendChild(s);
          });
        })
        .catch(() => { $('#box-chips').textContent = 'BOX情報なし'; });
    }

    $('#btn-retry')?.addEventListener('click', () => { loadYosou(); });

    loadYosou();
    loadBox();
  </script>
</body>
</html>
